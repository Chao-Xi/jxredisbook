
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Redis 技术与实战教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.5">
    
    
      
        <title>第五节 Redis缓冲区 - Jacob Redis Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#e92063">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="pink" data-md-color-accent="pink">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#redis" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Redis Book" class="md-header__button md-logo" aria-label="Jacob Redis Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Redis Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第五节 Redis缓冲区
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxredisbook.git/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxredisbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Redis Book" class="md-nav__button md-logo" aria-label="Jacob Redis Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Redis Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxredisbook.git/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxredisbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          第一章 Redis介绍
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第一章 Redis介绍" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          第一章 Redis介绍
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/1redis_intro/" class="md-nav__link">
        第一节 Redis 不得不去掌握的关键
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          第二章 Redis基础篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第二章 Redis基础篇" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          第二章 Redis基础篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/1redis_kv/" class="md-nav__link">
        第一节 基本架构： 键值数据库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/2redis_slowquery/" class="md-nav__link">
        第二节 数据结构：Redis为什么那么快？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/3redis_io/" class="md-nav__link">
        第三节 高性能IO模型：Redis为什么那么快？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/4redis_aof_log/" class="md-nav__link">
        第四节 Redis宕机，如何避免数据丢失：AOF日志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/5redis_rdb_snapshot/" class="md-nav__link">
        第五节 Redis宕机，Redis如何实现快速恢复RDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/6redis_master_slave_replicate/" class="md-nav__link">
        第六节 数据同步：主从库数据一致
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/7redis_master_rescue/" class="md-nav__link">
        第七节	哨兵机制：主库不间断服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/8redis_sentinel/" class="md-nav__link">
        第八节	哨兵集群：哨兵挂了，主从库切换
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/9redis_slot/" class="md-nav__link">
        第九节 切片集群：数据增多了，是该加内存还是加实例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/10redis_basic_sum/" class="md-nav__link">
        第二章 Redis核心技术基础总结篇
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          第三章 Redis数据结构
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第三章 Redis数据结构" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          第三章 Redis数据结构
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/1redis_string/" class="md-nav__link">
        第一节 Redis的String类型数据结构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/2redis_sets/" class="md-nav__link">
        第二节 Redis有那些数据结构适合做统计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/3redis_geo/" class="md-nav__link">
        第三节 GEO，一种可以实现LBS服务的数据结构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/4redis_timeseries/" class="md-nav__link">
        第四节 根据时间序列数据的特点，选择合适的存储方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/5redis_stream/" class="md-nav__link">
        第五节 如何使用redis实现消息队列的需求
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/6redis_ds_sum/" class="md-nav__link">
        第三章 Redis 的数据结构
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          第四章 Redis性能影响因子
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第四章 Redis性能影响因子" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          第四章 Redis性能影响因子
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1redis_asyn/" class="md-nav__link">
        第一节 Redis有哪些可能导致阻塞的操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2redis_cpu/" class="md-nav__link">
        第二节 在多核CPU架构和NUMA架构下对redis进行优化配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3redis_response/" class="md-nav__link">
        第三节 当redis查询变慢了怎么办？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4redis_fragmentation/" class="md-nav__link">
        第四节 删除数据后，内存占用率还是很高
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          第五节 Redis缓冲区
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        第五节 Redis缓冲区
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1、客户端输入和输出缓冲区
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2、如何应对输入缓冲区溢出？
  </a>
  
    <nav class="md-nav" aria-label="2、如何应对输入缓冲区溢出？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2-1" class="md-nav__link">
    2-1 缓冲区溢出检查
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2" class="md-nav__link">
    2-2 缓冲区溢的风险
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-3" class="md-nav__link">
    2-3 避免输入缓冲区溢出
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、如何应对输出缓冲区溢出？
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、主从集群中的缓冲区
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5、复制缓冲区的溢出问题
  </a>
  
    <nav class="md-nav" aria-label="5、复制缓冲区的溢出问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-1" class="md-nav__link">
    5-1 复制缓冲区的原因
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-2" class="md-nav__link">
    5-2 如何避免复制缓冲区发生溢出呢？
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    6、复制积压缓冲区的溢出问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7、本节小结
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../6redis_slow_respone/" class="md-nav__link">
        第四章 Redis 影响性能的潜在因素
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          第五章 Redis缓存介绍
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第五章 Redis缓存介绍" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          第五章 Redis缓存介绍
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/1redis_cache/" class="md-nav__link">
        第一节 Redis 旁路缓存
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/2redis_cache_full/" class="md-nav__link">
        第二节 缓存满后的替换策略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/3redis_mysql_uncon/" class="md-nav__link">
        第三节 如何解决缓存和数据库的数据不一致的缓存异常
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/4redis_contamination/" class="md-nav__link">
        第四节 缓存被污染的解决问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/5redis_cache_summary/" class="md-nav__link">
        第五章 Redis 缓存总结
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          第六章 Redis性能与锁机制以及ACID
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第六章 Redis性能与锁机制以及ACID" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          第六章 Redis性能与锁机制以及ACID
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/1redis_pika_ssd/" class="md-nav__link">
        第一节 基于SSD实现大容量Redis:Pika
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/2redis_locks/" class="md-nav__link">
        第二节 Redis应对并发访问：无锁的原子操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/3redis_distributed_locks/" class="md-nav__link">
        第三节 Redis实现分布式锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/4redis_acid/" class="md-nav__link">
        第四节 事务机制 Redis实现ACID属性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/5redis_perf/" class="md-nav__link">
        第六章 Redis性能与锁机制以及ACID总结
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          第七章 Redis Cluster集群介绍及管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第七章 Redis Cluster集群介绍及管理" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          第七章 Redis Cluster集群介绍及管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/1Redis_master_slave/" class="md-nav__link">
        第一节 Redis主从同步与故障切换的三个坑
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/2redis_brain_split/" class="md-nav__link">
        第二节 脑裂导致数据丢失
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/3redis_codis_cluster/" class="md-nav__link">
        第三节 Redis Codis 集群方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/4redis_spike_sys/" class="md-nav__link">
        第四节 Redis支撑秒杀场景的关键技术和实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/5redis_data_incline/" class="md-nav__link">
        第五节 数据分布优化应对数据倾斜
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/6redis_cluster_gossip/" class="md-nav__link">
        第六节 限制Redis Cluster规模的关键因素:通信开销
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/8Redis_HA/" class="md-nav__link">
        第七节 Redis 高可用性解决方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/7Redis_cluster_summary/" class="md-nav__link">
        第七章 Redis Cluster集群介绍及管理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          第八章 Redis学习与操作
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第八章 Redis学习与操作" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          第八章 Redis学习与操作
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/1redis_6.0_fea/" class="md-nav__link">
        第一节 Redis 6.0的新特性：多线程、客户端缓存与安全
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/2redis_nvm_mem/" class="md-nav__link">
        第二节 Redis 基于NVM内存的实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/3redis_RESP/" class="md-nav__link">
        第三节 Redis客户端如何与服务器端交换命令和数据 RESP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/4redis_opt_tools/" class="md-nav__link">
        第四节 Redis运维工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/5redis_protocol/" class="md-nav__link">
        第五节 Redis的使用规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/8redis_keys/" class="md-nav__link">
        第六节 Redis如何删除数量过万以上Key而不影响业务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/6redis_opt_summary/" class="md-nav__link">
        第八章 Redis学习与操作总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/7redis_shake/" class="md-nav__link">
        工具补充1：redis-shake数据同步和数据迁移
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          第九章 使用k8s安装Redis集群
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第九章 使用k8s安装Redis集群" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          第九章 使用k8s安装Redis集群
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/1redis_k8s_sts/" class="md-nav__link">
        第一节 Kubernetes上通过sts测试Redis Cluster
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/2redis_k8s_config/" class="md-nav__link">
        第二节 利用ConfigMap设置安装 Redis
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" type="checkbox" id="__nav_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_11">
          第十章 期末总结章
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十章 期末总结章" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          第十章 期末总结章
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/1redis_test/" class="md-nav__link">
        Redis 核心技术考题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/3Redis_basic/" class="md-nav__link">
        Redis 基础你掌握多少了？来个查漏补缺
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/2Redis_interview/" class="md-nav__link">
        40 道Redis面试题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/4Redis_int_all/" class="md-nav__link">
        115 道 Redis 面试题解答
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/5redis6_int/" class="md-nav__link">
        Redis6.0与缓存大全基础面试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1、客户端输入和输出缓冲区
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2、如何应对输入缓冲区溢出？
  </a>
  
    <nav class="md-nav" aria-label="2、如何应对输入缓冲区溢出？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2-1" class="md-nav__link">
    2-1 缓冲区溢出检查
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2" class="md-nav__link">
    2-2 缓冲区溢的风险
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-3" class="md-nav__link">
    2-3 避免输入缓冲区溢出
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、如何应对输出缓冲区溢出？
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、主从集群中的缓冲区
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5、复制缓冲区的溢出问题
  </a>
  
    <nav class="md-nav" aria-label="5、复制缓冲区的溢出问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-1" class="md-nav__link">
    5-1 复制缓冲区的原因
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-2" class="md-nav__link">
    5-2 如何避免复制缓冲区发生溢出呢？
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    6、复制积压缓冲区的溢出问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7、本节小结
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/Chao-Xi/jxredisbook.git/edit/master/docs/chap4/5redis_buffer.md" title="编辑此页" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>



<h1 id="redis"><strong>第五节 Redis缓冲区</strong></h1>
<p><strong>缓冲区的功能其实很简单，主要就是用一块内存空间来暂时存放命令数据，以免出现因为数据和命令的处理速度慢于发送速度而导致的数据丢失和性能问题。</strong></p>
<p>但因为缓冲区的内存空间有限，<strong>如果往里面写入数据的速度持续地大于从里面读取数据的速度，就会导致缓冲区需要越来越多的内存来暂存数据。当缓冲区占用的内存超出了设定的上限阈值时，就会出现缓冲区溢出。</strong></p>
<p>如果不给缓冲区的大小设置上限，随着累积的数据越来越多，<strong>缓冲区占用内存空间越来越大，一旦耗尽了 Redis 实例所在机器的可用内存，就会导致 Redis 实例崩溃</strong>。</p>
<p>缓冲区是用来避免请求或数据丢失的惨案的</p>
<p><strong>Redis 是典型的 <code>client-server</code> 架构，所有的操作命令都需要通过客户端发送给服务器端。</strong></p>
<p>所以，缓冲区在 Redis 中的一个主要应用场景，就是在客户端和服务器端之间进行通信时，用来暂存客户端发送的命令数据，或者是服务器端返回给客户端的数据结果。<strong>此外，缓冲区的另一个主要应用场景，是在主从节点间进行数据同步时，用来暂存主节点接收的写命令和数据</strong>。</p>
<h2 id="1"><strong>1、客户端输入和输出缓冲区</strong></h2>
<p>看看服务器端和客户端之间的缓冲区</p>
<p>为了避免客户端和服务器端的请求发送和处理速度不匹配，服务器端给每个连接的客户端都设置了一个输入缓冲区和输出缓冲区，我们称之为<strong>客户端输入缓冲区和输出缓冲区</strong>。</p>
<ul>
<li>输入缓冲区会先把客户端发送过来的命令暂存起来，</li>
<li>Redis 主线程再从输入缓冲区中读取命令，进行处理</li>
<li>当 Redis 主线程处理完数据后，会把结果写入到输出缓冲区，再通过输出缓冲区返回给客户端</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chap4_5_1.png" title="Body image" /></p>
<h2 id="2"><strong>2、如何应对输入缓冲区溢出？</strong></h2>
<h3 id="2-1"><strong>2-1 缓冲区溢出检查</strong></h3>
<p>输入缓冲区就是用来暂存客户端发送的请求命令的，所以可能导致溢出的情况主要是下面两种：</p>
<ul>
<li>写入了 bigkey，比如一下子写入了多个百万级别的集合类型数据；</li>
<li>服务器端处理请求的速度过慢，<strong>例如，Redis 主线程出现了间歇性阻塞，无法及时处理正常发送的请求，导致客户端发送的请求在缓冲区越积越多</strong>。</li>
</ul>
<p><strong><span style="color:red">如何查看输入缓冲区的内存使用情况，以及如何避免溢出</span></strong></p>
<p>要查看和服务器端相连的每个客户端对输入缓冲区的使用情况，我们可以使用 <code>CLIENT LIST</code> 命令：</p>
<pre><code>CLIENT LIST
id=5 addr=127.0.0.1:50487 fd=9 name= age=4 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=26 qbuf-free=32742 obl=0 oll=0 omem=0 events=r cmd=client
</code></pre>
<p>CLIENT 命令返回的信息虽然很多，但我们只需要重点关注两类信息就可以了。</p>
<p><strong>一类是与服务器端连接的客户端的信息。</strong>这个案例展示的是一个客户端的输入缓冲区情况，如果有多个客户端，输出结果中的 addr 会显示不同客户端的 IP 和端口号。</p>
<p>另一类是与输入缓冲区相关的三个参数：</p>
<ul>
<li><code>cmd</code>，<strong>表示客户端最新执行的命令</strong>。这个例子中执行的是 CLIENT 命令。</li>
<li><code>qbuf</code>，<strong>表示输入缓冲区已经使用的大小</strong>。这个例子中的 CLIENT 命令已使用了 26 字节大小的缓冲区。</li>
<li><strong><code>qbuf-free</code>，表示输入缓冲区尚未使用的大小</strong>。这个例子中的 CLIENT 命令还可以使用 32742 字节的缓冲区。<code>qbuf</code> 和 <code>qbuf-free</code>的总和就是，Redis 服务器端当前为已连接的这个客户端分配的缓冲区总大小。这个例子中总共分配了 <code>26 + 32742 = 32768</code> 字节，也就是 32KB 的缓冲区。</li>
</ul>
<h3 id="2-2"><strong>2-2 缓冲区溢的风险</strong></h3>
<p>有了 <code>CLIENT LIST</code> 命令，我们就可以通过输出结果来判断客户端输入缓冲区的内存占用情况了。<strong>如果 <code>qbuf</code> 很大，而同时 <code>qbuf-free</code> 很小，就要引起注意了，因为这时候输入缓冲区已经占用了很多内存，而且没有什么空闲空间了</strong>。</p>
<p>此时，客户端再写入大量命令的话，就会引起客户端输入缓冲区溢出，Redis 的处理办法就是把客户端连接关闭，结果就是业务程序无法进行数据存取了。</p>
<p>通常情况下，<strong>Redis 服务器端不止服务一个客户端，当多个客户端连接占用的内存总量，超过了 Redis 的 maxmemory 配置项时（例如 4GB），就会触发 Redis 进行数据淘汰</strong>。一旦数据被淘汰出 Redis，再要访问这部分数据，就需要去后端数据库读取，这就降低了业务应用的访问性能</p>
<p>更糟糕的是，如果使用多个客户端，导致 Redis 内存占用过大，也会导致内存溢出（<code>out-of-memory</code>）问题，进而会引起 Redis 崩溃，给业务应用造成严重影响。</p>
<h3 id="2-3"><strong>2-3 避免输入缓冲区溢出</strong></h3>
<p>避免输入缓冲区溢出。我们可以从两个角度去考虑如何避免，<strong><span style="color:red">一是把缓冲区调大，二是从数据命令的发送和处理速度入手。</span></strong></p>
<p><strong>底有没有办法通过参数调整输入缓冲区的大小呢？答案是没有。</strong></p>
<p>Redis 的客户端输入缓冲区大小的上限阈值，在代码中就设定为了 1GB。也就是说，Redis 服务器端允许为每个客户端最多暂存 1GB 的命令和数据。<strong>1GB 的大小，对于一般的生产环境已经是比较合适的了</strong>。</p>
<ul>
<li>一方面，这个大小对于处理绝大部分客户端的请求已经够用了；</li>
<li>另一方面，如果再大的话，<strong>Redis 就有可能因为客户端占用了过多的内存资源而崩溃</strong>。</li>
</ul>
<p>Redis 并没有提供参数让我们调节客户端输入缓冲区的大小。<strong><span style="color:red">如果要避免输入缓冲区溢出，那我们就只能从数据命令的发送和处理速度入手，也就是前面提到的避免客户端写入 bigkey，以及避免 Redis 主线程阻塞</span></strong>。</p>
<h2 id="3"><strong>3、如何应对输出缓冲区溢出？</strong></h2>
<p>Redis 的输出缓冲区暂存的是 Redis 主线程要返回给客户端的数据。一般来说，主线程返回给客户端的数据，既有简单且大小固定的 OK 响应（例如，执行 SET 命令）或报错信息，也有大小不固定的、包含具体数据的执行结果（例如，执行 HGET 命令）。</p>
<p>Redis 为每个客户端设置的输出缓冲区也包括两部分：</p>
<ul>
<li>是一个大小为 16KB 的固定缓冲空间，用来暂存 OK 响应和出错信息；</li>
<li>是一个可以动态增加的缓冲空间，用来暂存大小可变的响应结果。</li>
</ul>
<p><strong>那什么情况下会发生输出缓冲区溢出呢？</strong> 我为你总结了三种：</p>
<ul>
<li>服务器端返回 bigkey 的大量结果；</li>
<li>执行了 MONITOR 命令；</li>
<li>缓冲区大小设置得不合理。</li>
</ul>
<p><strong>其中，bigkey 原本就会占用大量的内存空间，所以服务器端返回的结果包含 bigkey，必然会影响输出缓冲区</strong></p>
<p><strong>MONITOR 命令是用来监测 Redis 执行的。</strong>执行这个命令之后，就会持续输出监测到的各个命令操作，如下所示：</p>
<pre><code>MONITOR
OK
1600617456.437129 [0 127.0.0.1:50487] &quot;COMMAND&quot;
1600617477.289667 [0 127.0.0.1:50487] &quot;info&quot; &quot;memory&quot;
</code></pre>
<p>MONITOR 的输出结果会持续占用输出缓冲区，并越占越多，最后的结果就是发生溢出。</p>
<p>我要给你一个小建议：<strong><span style="color:red">MONITOR 命令主要用在调试环境中，不要在线上生产环境中持续使用 MONITOR。</span></strong></p>
<p>如果在线上环境中偶尔使用 MONITOR 检查 Redis 的命令执行情况，是没问题的。</p>
<p><strong>接下来，我们看下输出缓冲区大小设置的问题。</strong></p>
<p>和输入缓冲区不同，我们可以通过 <code>client-output-buffer-limit</code> 配置项，来设置缓冲区的大小。具体设置的内容包括两方面：</p>
<ul>
<li>设置缓冲区大小的上限阈值；</li>
<li>设置输出缓冲区持续写入数据的数量上限阈值，和持续写入数据的时间的上限阈值。<ul>
<li><code>client-output-buffer-limit</code>来设置输出缓冲区的大小</li>
</ul>
</li>
</ul>
<p>在具体使用 <code>client-output-buffer-limit</code> 来设置缓冲区大小的时候，我们需要先区分下客户端的类型。</p>
<ul>
<li>对于和 Redis 实例进行交互的应用程序来说，主要使用两类客户端和 Redis 服务器端交互，分别是<strong>常规和 Redis 服务器端进行读写命令交互的普通客户端</strong>，以及订阅了 Redis 频道的订阅客户端。</li>
<li>此外，<strong>在 Redis 主从集群中，主节点上也有一类客户端（从节点客户端）用来和从节点进行数据同步</strong>，我会在介绍主从集群中的缓冲区时，向你具体介绍。</li>
</ul>
<p>当我们给普通客户端设置缓冲区大小时，通常可以在 Redis 配置文件中进行这样的设置：</p>
<pre><code>client-output-buffer-limit normal 0 0 0
</code></pre>
<p>其中，normal 表示当前设置的是普通客户端，<strong>第 1 个 0 设置的是缓冲区大小限制，第 2 个 0 和第 3 个 0 分别表示缓冲区持续写入量限制和持续写入时间限制</strong>。</p>
<p><strong>对于普通客户端来说，它每发送完一个请求，会等到请求结果返回后，再发送下一个请求，这种发送方式称为阻塞式发送。</strong></p>
<p>在这种情况下，如果不是读取体量特别大的 bigkey，服务器端的输出缓冲区一般不会被阻塞的。</p>
<p><strong><span style="color:red">所以，我们通常把普通客户端的缓冲区大小限制，以及持续写入量限制、持续写入时间限制都设置为 0，也就是不做限制。</span></strong></p>
<ul>
<li>对于订阅客户端来说，一旦订阅的 Redis 频道有消息了，服务器端都会通过输出缓冲区把消息发给客户端。</li>
<li>所以，订阅客户端和服务器间的消息发送方式，不属于阻塞式发送。</li>
<li>不过，如果频道消息较多的话，也会占用较多的输出缓冲区空间。</li>
</ul>
<p>因此，<strong>我们会给订阅客户端设置缓冲区大小限制、缓冲区持续写入量限制，以及持续写入时间限制</strong>，可以在 Redis 配置文件中这样设置：</p>
<pre><code>client-output-buffer-limit pubsub 8mb 2mb 60
</code></pre>
<p>其中，pubsub 参数表示当前是对订阅客户端进行设置；</p>
<ul>
<li><strong>8mb 表示<code>输出缓冲区</code>的大小上限为 8MB，一旦实际占用的缓冲区大小要超过 8MB，服务器端就会直接关闭客户端的连接；</strong></li>
<li><strong>2mb 和 60 表示，如果连续 60 秒内对输出缓冲区的写入量超过 2MB 的话，服务器端也会关闭客户端连接。</strong></li>
</ul>
<p>好了，我们来总结下如何应对输出缓冲区溢出：</p>
<ul>
<li>避免 bigkey 操作返回大量数据结果；</li>
<li>避免在线上环境中持续使用 MONITOR 命令。</li>
<li>使用 <code>client-output-buffer-limit</code> 设置合理的缓冲区大小上限，或是缓冲区连续写入时间和写入量上限。</li>
</ul>
<h2 id="4"><strong>4、主从集群中的缓冲区</strong></h2>
<p>主从集群间的数据复制包括全量复制和增量复制两种。</p>
<ul>
<li><strong>全量复制是同步所有数据，而增量复制只会把主从库网络断连期间主库收到的命令，同步给从库</strong></li>
<li>无论在哪种形式的复制中，<strong>为了保证主从节点的数据一致，都会用到缓冲区</strong>。</li>
<li>但是，这两种复制场景下的缓冲区，在溢出影响和大小设置方面并不一样。</li>
</ul>
<h2 id="5"><strong>5、复制缓冲区的溢出问题</strong></h2>
<h3 id="5-1"><strong>5-1 复制缓冲区的原因</strong></h3>
<p><strong>在全量复制过程中，主节点在向从节点传输 <code>RDB</code> 文件的同时，会继续接收客户端发送的写命令请求。</strong></p>
<ul>
<li><span style="color:red">这些写命令就会先保存在复制缓冲区中，等 RDB 文件传输完成后，再发送给从节点去执行</span>。</li>
<li>主节点上会为每个从节点都维护一个复制缓冲区，来保证主从节点间的数据同步。</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chap4_5_2.png" title="Body image" /></p>
<p>所以，如果在全量复制时，从节点接收和加载 RDB 较慢，同时主节点接收到了大量的写命令，<strong>写命令在复制缓冲区中就会越积越多，最终导致溢出</strong>。</p>
<ul>
<li>其实，主节点上的复制缓冲区，本质上也是一个用于和从节点连接的客户端（我们称之为从节点客户端），使用的输出缓冲区。</li>
<li>复制缓冲区一旦发生溢出，主节点也会直接关闭和从节点进行复制操作的连接，导致全量复制失败。</li>
</ul>
<h3 id="5-2"><strong>5-2 如何避免复制缓冲区发生溢出呢？</strong></h3>
<ol>
<li><strong>我们可以控制主节点保存的数据量大小</strong>。按通常的使用经验，我们会把主节点的数据量控制在 2~4GB，这样可以让全量同步执行得更快些，避免复制缓冲区累积过多命令。</li>
<li><strong>我们可以使用 <code>client-output-buffer-limit</code> 配置项，来设置合理的复制缓冲区大小</strong>。设置的依据，就是主节点的数据量大小、主节点的写负载压力和主节点本身的内存大小。</li>
</ol>
<pre><code>config set client-output-buffer-limit slave 512mb 128mb 60
</code></pre>
<ul>
<li><code>slave</code> 参数表明该配置项是<strong>针对复制缓冲区的</strong>。<ul>
<li><code>512mb</code> 代表将缓冲区大小的上限设置为 512MB；</li>
<li><code>128mb</code> 和 <code>60</code> 代表的设置是，如果连续 60 秒内的写入量超过 128MB 的话，也会触发缓冲区溢出。</li>
</ul>
</li>
</ul>
<p>假设一条写命令数据是 1KB，那么，复制缓冲区可以累积 512K 条（512MB/1KB = 512K）写命令。同时，主节点在全量复制期间，可以承受的写命令速率上限是 2000 条 /s（128MB/1KB/60 约等于 2000）。</p>
<p>在实际应用中设置复制缓冲区的大小时，<strong>可以根据写命令数据的大小和应用的实际负载情况（也就是写命令速率），来粗略估计缓冲区中会累积的写命令数据量；</strong></p>
<p>然后，再和所设置的复制缓冲区大小进行比较，判断设置的缓冲区大小是否足够支撑累积的写命令数据量。</p>
<p>主节点上复制缓冲区的内存开销，会是每个从节点客户端输出缓冲区占用内存的总和。如果集群中的从节点数非常多的话，<strong>主节点的内存开销就会非常大。所以，我们还必须得控制和主节点连接的从节点个数，不要使用大规模的主从集群</strong>。</p>
<p>为了避免复制缓冲区累积过多命令造成溢出，引发全量复制失败，<strong>我们可以控制主节点保存的数据量大小，并设置合理的复制缓冲区大小。同时，我们需要控制从节点的数量，来避免主节点中复制缓冲区占用过多内存的问题。</strong></p>
<h2 id="6"><strong>6、复制积压缓冲区的溢出问题</strong></h2>
<p><strong><span style="color:red">增量复制时使用的缓冲区，这个缓冲区称为复制积压缓冲区。</span></strong></p>
<ul>
<li>主节点在把接收到的写命令同步给从节点时，同时会把这些写命令写入<strong>复制积压缓冲区</strong>。</li>
<li>一旦从节点发生网络闪断，再次和主节点恢复连接后，<strong>从节点就会从复制积压缓冲区中，读取断连期间主节点接收到的写命令，进而进行增量同步</strong>，</li>
</ul>
<p>如下图所示：</p>
<p><img alt="Alt Image Text" src="../../images/chap4_5_3.png" title="Body image" /></p>
<p><a href="https://chao-xi.github.io/jxredisbook/chap2/6redis_master_slave_replicate/#3-1-">复制积压缓冲区了，<code>repl_backlog_buffer</code>,增量复制</a>，复制积压缓冲区溢出的影响，以及如何应对复制积压缓冲区的溢出问题。</p>
<ul>
<li>首先，复制积压缓冲区是一个大小有限的环形缓冲区。当主节点把复制积压缓冲区写满后，会覆盖缓冲区中的旧命令数据。如果从节点还没有同步这些旧命令数据，就会造成主从节点间重新开始执行全量复制。</li>
<li>其次，为了应对复制积压缓冲区的溢出问题，我们可以调整复制积压缓冲区的大小，也就是设置 <code>repl_backlog_size</code> 这个参数的值。</li>
</ul>
<h2 id="7"><strong>7、本节小结</strong></h2>
<p>使用缓冲区以后，当命令数据的接收方处理速度跟不上发送方的发送速度时，缓冲区可以避免命令数据的丢失。</p>
<p>按照缓冲区的用途，例如是用于客户端通信还是用于主从节点复制，我把缓冲区分成了</p>
<ul>
<li><strong>客户端的输入</strong></li>
<li><strong>客户端输出缓冲区</strong></li>
<li><strong>主从集群中主节点上的复制缓冲区</strong></li>
<li><strong>复制积压缓冲区</strong></li>
</ul>
<p>现在，从缓冲区溢出对 Redis 的影响的角度，我再把这四个缓冲区分成两类做个总结。</p>
<ul>
<li>缓冲区溢出导致网络连接关闭：普通客户端、订阅客户端，以及从节点客户端，它们使用的缓冲区，本质上都是 Redis 客户端和服务器端之间，或是主从节点之间为了传输命令数据而维护的。这些缓冲区一旦发生溢出，处理机制都是直接把客户端和服务器端的连接，或是主从节点间的连接关闭。网络连接关闭造成的直接影响，就是业务程序无法读写 Redis，或者是主从节点全量同步失败，需要重新执行。</li>
<li>缓冲区溢出导致命令数据丢失：主节点上的复制积压缓冲区属于环形缓冲区，一旦发生溢出，新写入的命令数据就会覆盖旧的命令数据，导致旧命令数据的丢失，进而导致主从节点重新进行全量复制。</li>
</ul>
<p>从本质上看，缓冲区溢出，无非就是三个原因：</p>
<ul>
<li>命令数据发送过快过大；</li>
<li>命令数据处理较慢；</li>
<li>缓冲区空间过小。</li>
</ul>
<p>明白了这个，我们就可以有针对性地拿出应对策略了。</p>
<ul>
<li>针对命令数据发送过快过大的问题，对于普通客户端来说可以避免 bigkey，而对于复制缓冲区来说，就是避免过大的 RDB 文件。</li>
<li>针对命令数据处理较慢的问题，解决方案就是减少 Redis 主线程上的阻塞操作，例如使用异步的删除操作。</li>
<li><strong>针对缓冲区空间过小的问题，解决方案就是使用 <code>client-output-buffer-limit</code> 配置项设置合理的输出缓冲区、复制缓冲区和复制积压缓冲区大小</strong>。当然，我们不要忘了，输入缓冲区的大小默认是固定的，我们无法通过配置来修改它，除非直接去修改 Redis 源码。</li>
</ul>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="../4redis_fragmentation/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 第四节 删除数据后，内存占用率还是很高" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              第四节 删除数据后，内存占用率还是很高
            </div>
          </div>
        </a>
      
      
        
        <a href="../6redis_slow_respone/" class="md-footer__link md-footer__link--next" aria-label="下一页: 第四章 Redis 影响性能的潜在因素" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              第四章 Redis 影响性能的潜在因素
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "search": "../../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.467223ff.min.js"></script>
      
    
  </body>
</html>