
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Redis 技术与实战教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.5">
    
    
      
        <title>第三节 GEO，一种可以实现LBS服务的数据结构 - Jacob Redis Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#e92063">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="pink" data-md-color-accent="pink">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#geolbs" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Redis Book" class="md-header__button md-logo" aria-label="Jacob Redis Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Redis Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第三节 GEO，一种可以实现LBS服务的数据结构
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxredisbook.git/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxredisbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Redis Book" class="md-nav__button md-logo" aria-label="Jacob Redis Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Redis Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxredisbook.git/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxredisbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          第一章 Redis介绍
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第一章 Redis介绍" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          第一章 Redis介绍
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/1redis_intro/" class="md-nav__link">
        第一节 Redis 不得不去掌握的关键
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          第二章 Redis基础篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第二章 Redis基础篇" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          第二章 Redis基础篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/1redis_kv/" class="md-nav__link">
        第一节 基本架构： 键值数据库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/2redis_slowquery/" class="md-nav__link">
        第二节 数据结构：Redis为什么那么快？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/3redis_io/" class="md-nav__link">
        第三节 高性能IO模型：Redis为什么那么快？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/4redis_aof_log/" class="md-nav__link">
        第四节 Redis宕机，如何避免数据丢失：AOF日志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/5redis_rdb_snapshot/" class="md-nav__link">
        第五节 Redis宕机，Redis如何实现快速恢复RDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/6redis_master_slave_replicate/" class="md-nav__link">
        第六节 数据同步：主从库数据一致
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/7redis_master_rescue/" class="md-nav__link">
        第七节	哨兵机制：主库不间断服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/8redis_sentinel/" class="md-nav__link">
        第八节	哨兵集群：哨兵挂了，主从库切换
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/9redis_slot/" class="md-nav__link">
        第九节 切片集群：数据增多了，是该加内存还是加实例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/10redis_basic_sum/" class="md-nav__link">
        第二章 Redis核心技术基础总结篇
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          第三章 Redis数据结构
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第三章 Redis数据结构" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          第三章 Redis数据结构
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1redis_string/" class="md-nav__link">
        第一节 Redis的String类型数据结构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2redis_sets/" class="md-nav__link">
        第二节 Redis有那些数据结构适合做统计
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          第三节 GEO，一种可以实现LBS服务的数据结构
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        第三节 GEO，一种可以实现LBS服务的数据结构
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-lbs-geo" class="md-nav__link">
    1、面向 LBS 应用的 GEO 数据类型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2geo" class="md-nav__link">
    2、GEO 的底层结构
  </a>
  
    <nav class="md-nav" aria-label="2、GEO 的底层结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2-1-lbs" class="md-nav__link">
    2-1 LBS 应用纬度的存取特点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-sorted-set" class="md-nav__link">
    2-2 Sorted Set 类型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3geohash" class="md-nav__link">
    3、GeoHash 的编码方法
  </a>
  
    <nav class="md-nav" aria-label="3、GeoHash 的编码方法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3-1" class="md-nav__link">
    3-1 经度和纬度的单独编码过程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-2-geohash" class="md-nav__link">
    3-2 GeoHash 编码分区
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-geo" class="md-nav__link">
    4、如何操作 GEO 类型？
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5、如何自定义数据类型？
  </a>
  
    <nav class="md-nav" aria-label="5、如何自定义数据类型？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-1-redis" class="md-nav__link">
    5-1 Redis 的基本对象结构
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    6、开发一个新的数据类型
  </a>
  
    <nav class="md-nav" aria-label="6、开发一个新的数据类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#6-1" class="md-nav__link">
    6-1 第一步：定义新数据类型的底层结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-2-redisobject-type" class="md-nav__link">
    6-2 第二步：在 RedisObject 的 type 属性中，增加这个新类型的定义
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-3" class="md-nav__link">
    6-3 第三步：开发新类型的创建和释放函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-4" class="md-nav__link">
    6-4 第四步：开发新类型的命令操作
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7、本节小结
  </a>
  
    <nav class="md-nav" aria-label="7、本节小结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#7-1" class="md-nav__link">
    7-1 要点&amp;亮点？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-2" class="md-nav__link">
    7-2 每课一问
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4redis_timeseries/" class="md-nav__link">
        第四节 根据时间序列数据的特点，选择合适的存储方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../5redis_stream/" class="md-nav__link">
        第五节 如何使用redis实现消息队列的需求
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../6redis_ds_sum/" class="md-nav__link">
        第三章 Redis 的数据结构
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          第四章 Redis性能影响因子
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第四章 Redis性能影响因子" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          第四章 Redis性能影响因子
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/1redis_asyn/" class="md-nav__link">
        第一节 Redis有哪些可能导致阻塞的操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/2redis_cpu/" class="md-nav__link">
        第二节 在多核CPU架构和NUMA架构下对redis进行优化配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/3redis_response/" class="md-nav__link">
        第三节 当redis查询变慢了怎么办？
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/4redis_fragmentation/" class="md-nav__link">
        第四节 删除数据后，内存占用率还是很高
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/5redis_buffer/" class="md-nav__link">
        第五节 Redis缓冲区
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/6redis_slow_respone/" class="md-nav__link">
        第四章 Redis 影响性能的潜在因素
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          第五章 Redis缓存介绍
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第五章 Redis缓存介绍" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          第五章 Redis缓存介绍
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/1redis_cache/" class="md-nav__link">
        第一节 Redis 旁路缓存
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/2redis_cache_full/" class="md-nav__link">
        第二节 缓存满后的替换策略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/3redis_mysql_uncon/" class="md-nav__link">
        第三节 如何解决缓存和数据库的数据不一致的缓存异常
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/4redis_contamination/" class="md-nav__link">
        第四节 缓存被污染的解决问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/5redis_cache_summary/" class="md-nav__link">
        第五章 Redis 缓存总结
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          第六章 Redis性能与锁机制以及ACID
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第六章 Redis性能与锁机制以及ACID" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          第六章 Redis性能与锁机制以及ACID
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/1redis_pika_ssd/" class="md-nav__link">
        第一节 基于SSD实现大容量Redis:Pika
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/2redis_locks/" class="md-nav__link">
        第二节 Redis应对并发访问：无锁的原子操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/3redis_distributed_locks/" class="md-nav__link">
        第三节 Redis实现分布式锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/4redis_acid/" class="md-nav__link">
        第四节 事务机制 Redis实现ACID属性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/5redis_perf/" class="md-nav__link">
        第六章 Redis性能与锁机制以及ACID总结
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          第七章 Redis Cluster集群介绍及管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第七章 Redis Cluster集群介绍及管理" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          第七章 Redis Cluster集群介绍及管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/1Redis_master_slave/" class="md-nav__link">
        第一节 Redis主从同步与故障切换的三个坑
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/2redis_brain_split/" class="md-nav__link">
        第二节 脑裂导致数据丢失
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/3redis_codis_cluster/" class="md-nav__link">
        第三节 Redis Codis 集群方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/4redis_spike_sys/" class="md-nav__link">
        第四节 Redis支撑秒杀场景的关键技术和实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/5redis_data_incline/" class="md-nav__link">
        第五节 数据分布优化应对数据倾斜
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/6redis_cluster_gossip/" class="md-nav__link">
        第六节 限制Redis Cluster规模的关键因素:通信开销
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/8Redis_HA/" class="md-nav__link">
        第七节 Redis 高可用性解决方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/7Redis_cluster_summary/" class="md-nav__link">
        第七章 Redis Cluster集群介绍及管理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          第八章 Redis学习与操作
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第八章 Redis学习与操作" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          第八章 Redis学习与操作
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/1redis_6.0_fea/" class="md-nav__link">
        第一节 Redis 6.0的新特性：多线程、客户端缓存与安全
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/2redis_nvm_mem/" class="md-nav__link">
        第二节 Redis 基于NVM内存的实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/3redis_RESP/" class="md-nav__link">
        第三节 Redis客户端如何与服务器端交换命令和数据 RESP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/4redis_opt_tools/" class="md-nav__link">
        第四节 Redis运维工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/5redis_protocol/" class="md-nav__link">
        第五节 Redis的使用规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/8redis_keys/" class="md-nav__link">
        第六节 Redis如何删除数量过万以上Key而不影响业务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/6redis_opt_summary/" class="md-nav__link">
        第八章 Redis学习与操作总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/7redis_shake/" class="md-nav__link">
        工具补充1：redis-shake数据同步和数据迁移
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          第九章 使用k8s安装Redis集群
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第九章 使用k8s安装Redis集群" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          第九章 使用k8s安装Redis集群
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/1redis_k8s_sts/" class="md-nav__link">
        第一节 Kubernetes上通过sts测试Redis Cluster
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/2redis_k8s_config/" class="md-nav__link">
        第二节 利用ConfigMap设置安装 Redis
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" type="checkbox" id="__nav_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_11">
          第十章 期末总结章
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十章 期末总结章" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          第十章 期末总结章
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/1redis_test/" class="md-nav__link">
        Redis 核心技术考题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/3Redis_basic/" class="md-nav__link">
        Redis 基础你掌握多少了？来个查漏补缺
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/2Redis_interview/" class="md-nav__link">
        40 道Redis面试题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/4Redis_int_all/" class="md-nav__link">
        115 道 Redis 面试题解答
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/5redis6_int/" class="md-nav__link">
        Redis6.0与缓存大全基础面试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-lbs-geo" class="md-nav__link">
    1、面向 LBS 应用的 GEO 数据类型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2geo" class="md-nav__link">
    2、GEO 的底层结构
  </a>
  
    <nav class="md-nav" aria-label="2、GEO 的底层结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2-1-lbs" class="md-nav__link">
    2-1 LBS 应用纬度的存取特点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-sorted-set" class="md-nav__link">
    2-2 Sorted Set 类型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3geohash" class="md-nav__link">
    3、GeoHash 的编码方法
  </a>
  
    <nav class="md-nav" aria-label="3、GeoHash 的编码方法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3-1" class="md-nav__link">
    3-1 经度和纬度的单独编码过程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-2-geohash" class="md-nav__link">
    3-2 GeoHash 编码分区
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-geo" class="md-nav__link">
    4、如何操作 GEO 类型？
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5、如何自定义数据类型？
  </a>
  
    <nav class="md-nav" aria-label="5、如何自定义数据类型？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-1-redis" class="md-nav__link">
    5-1 Redis 的基本对象结构
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    6、开发一个新的数据类型
  </a>
  
    <nav class="md-nav" aria-label="6、开发一个新的数据类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#6-1" class="md-nav__link">
    6-1 第一步：定义新数据类型的底层结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-2-redisobject-type" class="md-nav__link">
    6-2 第二步：在 RedisObject 的 type 属性中，增加这个新类型的定义
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-3" class="md-nav__link">
    6-3 第三步：开发新类型的创建和释放函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-4" class="md-nav__link">
    6-4 第四步：开发新类型的命令操作
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7、本节小结
  </a>
  
    <nav class="md-nav" aria-label="7、本节小结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#7-1" class="md-nav__link">
    7-1 要点&amp;亮点？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-2" class="md-nav__link">
    7-2 每课一问
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/Chao-Xi/jxredisbook.git/edit/master/docs/chap3/3redis_geo.md" title="编辑此页" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>



<h1 id="geolbs"><strong>第三节 GEO，一种可以实现LBS服务的数据结构</strong></h1>
<p>上一节讲了 5 大基本数据类型：<strong>String、List、Hash、Set 和 Sorted Set，它们可以满足大多数的数据存储需求，但是在面对海量数据统计时，它们的内存开销很大</strong>，而且对于一些特殊的场景，它们是无法支持的。</p>
<p><strong>Redis 还提供了 3 种扩展数据类型，分别是 Bitmap、HyperLogLog 和 GEO</strong></p>
<h2 id="1-lbs-geo"><strong>1、面向 LBS 应用的 GEO 数据类型</strong></h2>
<p>基于位置信息服务（Location-Based Service，LBS）的应用。LBS 应用访问的数据是和人或物关联的一组经纬度信息，而且要能查询相邻的经纬度范围，GEO 就非常适合应用在 LBS 服务的场景中，我们来看一下它的底层结构。</p>
<h2 id="2geo"><strong>2、GEO 的底层结构</strong></h2>
<h3 id="2-1-lbs"><strong>2-1 LBS 应用纬度的存取特点</strong></h3>
<p><strong>一般来说，在设计一个数据类型的底层结构时，我们首先需要知道，要处理的数据有什么访问特点。</strong>所以，我们需要先搞清楚位置信息到底是怎么被存取的。</p>
<p>以叫车服务为例，来分析下 LBS 应用中经纬度的存取特点。</p>
<ul>
<li>每一辆网约车都有一个编号（例如 33），网约车需要将自己的经度信息（例如 116.034579）和纬度信息（例如 39.000452 ）发给叫车应用。</li>
<li>用户在叫车的时候，叫车应用会根据用户的经纬度位置（例如经度 116.054579，纬度 39.030452），查找用户的附近车辆，并进行匹配。</li>
<li>等把位置相近的用户和车辆匹配上以后，叫车应用就会根据车辆的编号，获取车辆的信息，并返回给用户。</li>
</ul>
<p><strong>一辆车（或一个用户）对应一组经纬度，并且随着车（或用户）的位置移动，相应的经纬度也会变化。</strong></p>
<p>数据记录模式属于一个 key（例如车 ID）对应一个 value（一组经纬度）。当有很多车辆信息要保存时，就需要有一个集合来保存一系列的 key 和 value。</p>
<p><strong>Hash 集合类型可以快速存取一系列的 key 和 value</strong>，<strong>正好可以用来记录一系列车辆 ID 和经纬度的对应关系</strong>，所以，我们可以把不同车辆的 ID 和它们对应的经纬度信息存在 Hash 集合中</p>
<p><img alt="Alt Image Text" src="../../images/chap3_3_1.png" title="Body image" /></p>
<p><strong>Hash 类型的 HSET 操作命令，会根据 key 来设置相应的 value 值</strong>，所以，我们可以用它来快速地更新车辆变化的经纬度信息。</p>
<h3 id="2-2-sorted-set"><strong>2-2 Sorted Set 类型</strong></h3>
<p>Sorted Set 类型也支持一个 key 对应一个 value 的记录模式，其中，key 就是 Sorted Set 中的元素，而 value 则是元素的权重分数。更重要的是，Sorted Set 可以根据元素的权重分数排序，支持范围查询。</p>
<p><strong>实际上，GEO 类型的底层数据结构就是用 Sorted Set 来实现的</strong></p>
<p>用 Sorted Set 来保存车辆的经纬度信息时，Sorted Set 的元素是车辆 ID，元素的权重分数是经纬度信息，如下图所示：</p>
<p><img alt="Alt Image Text" src="../../images/chap3_3_2.png" title="Body image" /></p>
<p>Sorted Set 元素的权重分数是一个浮点数（float 类型），而一组经纬度包含的是经度和纬度两个值，是没法直接保存为一个浮点数的，那具体该怎么进行保存呢？</p>
<p>这就要用到 GEO 类型中的 GeoHash 编码了。</p>
<h2 id="3geohash"><strong>3、GeoHash 的编码方法</strong></h2>
<p>为了能高效地对经纬度进行比较，Redis 采用了业界广泛使用的 GeoHash 编码方法，这个方法的基本原理就是“二分区间，区间编码”。</p>
<p><strong>对一组经纬度进行 GeoHash 编码时，我们要先对经度和纬度分别编码，然后再把经纬度各自的编码组合成一个最终编码。</strong></p>
<h3 id="3-1"><strong>3-1 经度和纬度的单独编码过程</strong></h3>
<p>对于一个地理位置信息来说，它的经度范围是<code>[-180,180]</code>。GeoHash 编码会把一个经度值编码成一个 N 位的二进制值，我们来对经度范围<code>[-180,180]</code>做 N 次的二分区操作，其中 N 可以自定义。</p>
<p>在进行第一次二分区时，经度范围[-180,180]会被分成两个子区间：<code>[-180,0)</code> 和<code>[0,180]</code>（我称之为左、右分区）。</p>
<p>此时，我们可以查看一下要编码的经度值落在了左分区还是右分区。</p>
<p><strong><span style="color:red">如果是落在左分区，我们就用 0 表示；如果落在右分区，就用 1 表示。这样一来，每做完一次二分区，我们就可以得到 1 位编码值。</span></strong></p>
<p>我们再对经度值所属的分区再做一次二分区，<strong>同时再次查看经度值落在了二分区后的左分区还是右分区，按照刚才的规则再做 1 位编码。当做完 N 次的二分区后，经度值就可以用一个 N bit 的数来表示了。</strong></p>
<p>举个例子，假设我们要编码的经度值是 116.37，我们用 5 位编码值（也就是 N=5，做 5 次分区）。</p>
<ul>
<li>我们先做第一次二分区操作，把经度区间<code>[-180,180]</code>分成了左分区<code>[-180,0)</code>和右分区<code>[0,180]</code>，此时，经度值 <code>116.37</code> 是属于右分区<code>[0,180]</code>，所以，我们用 1 表示第一次二分区后的编码值。
<strong>* 第二次二分区：把经度值 <code>116.37</code> 所属的<code>[0,180]</code>区间，分成<code>[0,90)</code> 和<code>[90, 180]</code>。</strong></li>
<li>此时，经度值 <code>116.37</code> 还是属于右分区<code>[90,180]</code>，所以，第二次分区后的编码值仍然为 <code>1</code>。</li>
<li>等到第三次对<code>[90,180]</code>进行二分区，经度值<code>116.37</code> 落在了分区后的左分区<code>[90, 135)</code>中，所以，第三次分区后的编码值就是 0。</li>
</ul>
<p>按照这种方法，做完 5 次分区后，我们把经度值 116.37 定位在<code>[112.5, 123.75]</code>这个区间，并且得到了经度值的 5 位编码值，即 11010。</p>
<p><img alt="Alt Image Text" src="../../images/chap3_3_3.png" title="Body image" /></p>
<p>对纬度的编码方式，和对经度的一样，只是纬度的范围是[-90，90]，下面这张表显示了对纬度值 39.86 的编码过程。</p>
<p><img alt="Alt Image Text" src="../../images/chap3_3_4.png" title="Body image" /></p>
<p>当一组经纬度值都编完码后，我们再把它们的各自编码值组合在一起，组合的规则是：<strong>最终编码值的偶数位上依次是经度的编码值，奇数位上依次是纬度的编码值，其中，偶数位从 0 开始，奇数位从 1 开始。</strong></p>
<p>计算的经纬度<code>（116.37，39.86）</code>的各自编码值是 <code>11010</code>和 <code>10111</code>，组合之后，第 0 位是经度的第 0 位 1，第 1 位是纬度的第 0 位 1，第 2 位是经度的第 1 位 1，第 3 位是纬度的第 1 位 0，以此类推，就能得到最终编码值 <code>1110011101</code>，如下图所示：</p>
<p><img alt="Alt Image Text" src="../../images/chap3_3_5.png" title="Body image" /></p>
<p>用了 GeoHash 编码后，原来无法用一个权重分数表示的一组经纬度（116.37，39.86）就可以用 1110011101 这一个值来表示，就可以保存为 Sorted Set 的权重分数了。</p>
<h3 id="3-2-geohash"><strong>3-2 GeoHash 编码分区</strong></h3>
<p>当然，使用 GeoHash 编码后，我们相当于把整个地理空间划分成了一个个方格，每个方格对应了 GeoHash 中的一个分区。</p>
<p><strong>举个例子。我们把经度区间<code>[-180,180]</code>做一次二分区，把纬度区间<code>[-90,90]</code>做一次二分区，就会得到 4 个分区。</strong>我们来看下它们的经度和纬度范围以及对应的 GeoHash 组合编码。</p>
<ul>
<li>分区一：<code>[-180,0)</code> 和<code>[-90,0)</code>，编码 00；</li>
<li>分区二：<code>[-180,0)</code> 和<code>[0,90]</code>，编码 01；</li>
<li>分区三：<code>[0,180]</code>和<code>[-90,0)</code>，编码 10；</li>
<li>分区四：<code>[0,180]</code>和<code>[0,90]</code>，编码 11。</li>
</ul>
<p>这 4 个分区对应了 4 个方格，每个方格覆盖了一定范围内的经纬度值，分区越多，每个方格能覆盖到的地理空间就越小，也就越精准。我们把所有方格的编码值映射到一维空间时，相邻方格的 GeoHash 编码值基本也是接近的，</p>
<p><img alt="Alt Image Text" src="../../images/chap3_3_6.png" title="Body image" /></p>
<p>我们使用 Sorted Set 范围查询得到的相近编码值，在实际的地理空间上，也是相邻的方格，这就可以实现 LBS 应用“搜索附近的人或物”的功能了。</p>
<p>有的编码值虽然在大小上接近，但实际对应的方格却距离比较远。例如，我们用 4 位来做 GeoHash 编码，把经度区间<code>[-180,180]</code>和纬度区间<code>[-90,90]</code>各分成了 4 个分区，一共 <code>16</code> 个分区，对应了 16 个方格。编码值为 <code>0111</code> 和 <code>1000</code> 的两个方格就离得比较远，如下图所示：</p>
<p><img alt="Alt Image Text" src="../../images/chap3_3_7.png" title="Body image" /></p>
<p>所以，为了避免查询不准确问题，我们可以同时查询给定经纬度所在的方格周围的 <code>4</code> 个或 <code>8</code>个方格。</p>
<p>GEO 类型是把经纬度所在的区间编码作为 <code>Sorted Set</code> 中元素的权重分数，把和经纬度相关的车辆 ID 作为 Sorted Set 中元素本身的值保存下来，这样相邻经纬度的查询就可以通过编码值的大小范围查询来实现了</p>
<h2 id="4-geo"><strong>4、如何操作 GEO 类型？</strong></h2>
<p>在使用 GEO 类型时，我们经常会用到两个命令，分别是 GEOADD 和 GEORADIUS。</p>
<ul>
<li><code>GEOADD</code>命令：用于把一组经纬度信息和相对应的一个 ID 记录到 GEO 类型集合中；</li>
<li><code>GEORADIUS</code> 命令：会根据输入的经纬度位置，查找以这个经纬度为中心的一定范围内的其他元素。当然，我们可以自己定义这个范围。</li>
</ul>
<p>我还是以叫车应用的车辆匹配场景为例，介绍下具体如何使用这两个命令。</p>
<p>假设车辆 ID 是 33，经纬度位置是<code>（116.034579，39.030452）</code>，我们可以用一个 GEO 集合保存所有车辆的经纬度，集合 key 是 <code>cars:locations</code>。</p>
<p>执行下面的这个命令，<strong>就可以把 ID 号为 33 的车辆的当前经纬度位置存入 GEO 集合中</strong>：</p>
<pre><code>GEOADD cars:locations 116.034579 39.030452 33
</code></pre>
<p><strong>基本的写法：<code>geoadd key longitude latitude member</code> 注： <code>latitude [ˈlætɪtjuːd]</code> 纬度 <code>longtitude</code> 经度</strong></p>
<p>当用户想要寻找自己附近的网约车时，LBS 应用就可以使用 GEORADIUS 命令。</p>
<p>例如，LBS 应用执行下面的命令时，Redis 会根据输入的用户的经纬度信息（116.054579，39.030452 ），<strong>查找以这个经纬度为中心的 5 公里内的车辆信息，并返回给 LBS 应用。当然， 你可以修改“5”这个参数，来返回更大或更小范围内的车辆信息。</strong></p>
<pre><code>GEORADIUS cars:locations 116.054579 39.030452 5 km ASC COUNT 10
</code></pre>
<p><strong>我们还可以进一步限定返回的车辆信息。</strong></p>
<p>比如，我们可以使用 <code>ASC</code> 选项，让返回的车辆信息按照距离这个中心位置<strong>从近到远的方式来排序，以方便选择最近的车辆；</strong></p>
<h2 id="5"><strong>5、如何自定义数据类型？</strong></h2>
<p>但是有些场景下，我们对数据类型会有特殊需求，例如，我们需要一个数据类型既能像 Hash 那样支持快速的单键查询，又能像 Sorted Set 那样支持范围查询，此时，我们之前学习的这些数据类型就无法满足需求了。</p>
<p>为了实现自定义数据类型，<strong>首先，我们需要了解 Redis 的基本对象结构 RedisObject，因为 Redis 键值对中的每一个值都是用 RedisObject 保存的</strong>。</p>
<p><strong>RedisObject 包括元数据和指针：</strong></p>
<ul>
<li><strong>元数据的一个功能就是用来区分不同的数据类型</strong></li>
<li><strong>指针用来指向具体的数据类型的值</strong></li>
</ul>
<h3 id="5-1-redis"><strong>5-1 Redis 的基本对象结构</strong></h3>
<p><strong>RedisObject</strong> 的内部组成包括了 <code>type</code>、<code>encoding</code>、<code>lru</code>和 <code>refcount</code> 4 个元数据，以及 1 个<code>*ptr</code>指针。</p>
<ul>
<li>type：<strong>表示值的类型</strong>，涵盖了我们前面学习的五大基本类型；</li>
<li><code>encoding</code>：是值的编码方式，用来表示 Redis 中实现各个基本类型的底层数据结构，例如 SDS、压缩列表、哈希表、跳表等；</li>
<li><code>lru</code>：记录了这个对象最后一次被访问的时间，用于淘汰过期的键值对；</li>
<li><code>refcount</code>：记录了对象的引用计数；</li>
<li><code>*ptr</code>：是指向数据的指针。</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chap3_3_8.png" title="Body image" /></p>
<p><strong><code>RedisObject</code>结构借助<code>*ptr</code>指针，就可以指向不同的数据类型</strong></p>
<p>例如，<code>*ptr</code>指向一个 SDS 或一个跳表，就表示键值对中的值是 <code>String</code>类型或 <code>Sorted Set</code> 类型。</p>
<p>所以，我们在定义了新的数据类型后，也只要在 <code>RedisObject</code> 中设置好新类型的 <code>type</code> 和 <code>encoding</code>，再用<code>*ptr</code>指向新类型的实现，就行了。</p>
<h2 id="6"><strong>6、开发一个新的数据类型</strong></h2>
<p>了解了 RedisObject 结构后，定义一个新的数据类型也就不难了。</p>
<p>首先，我们需要为新数据类型定义好它的底层结构、type 和 encoding 属性值，然后再实现新数据类型的创建、释放函数和基本命令。</p>
<p>接下来，我以开发一个名字叫作 <code>NewTypeObject</code> 的新数据类型为例，来解释下具体的 4 个操作步骤。</p>
<p><img alt="Alt Image Text" src="../../images/chap3_3_9.png" title="Body image" /></p>
<h3 id="6-1"><strong>6-1 第一步：定义新数据类型的底层结构</strong></h3>
<p>我们用 <code>newtype.h</code> 文件来保存这个新类型的定义，具体定义的代码如下所示：</p>
<pre><code>struct NewTypeObject {
    struct NewTypeNode *head; 
    size_t len; 
}NewTypeObject;
</code></pre>
<p>其中，<code>NewTypeNode</code> 结构就是我们自定义的新类型的底层结构。我们为底层结构设计两个成员变量：一个是 Long 类型的 value 值，用来保存实际数据；一个是<code>*next</code>指针，指向下一个 <code>NewTypeNode</code>  结构。</p>
<pre><code>struct NewTypeNode {
    long value;
    struct NewTypeNode *next;
};
</code></pre>
<p>从代码中可以看到，<code>NewTypeObject</code> 类型的底层结构其实就是一个 <code>Long</code> 类型的单向链表。当然，你还可以根据自己的需求，把 <code>NewTypeObject</code> 的底层结构定义为其他类型。</p>
<p>例如，如果我们想要 <code>NewTypeObject</code> 的查询效率比链表高，就可以把它的底层结构设计成一颗 <code>B+</code> 树。</p>
<h3 id="6-2-redisobject-type"><strong>6-2 第二步：在 RedisObject 的 type 属性中，增加这个新类型的定义</strong></h3>
<p>这个定义是在 Redis 的 server.h 文件中。比如，我们增加一个叫作 <code>OBJ_NEWTYPE</code> 的宏定义，用来在代码中指代 <code>NewTypeObject</code> 这个新类型。</p>
<pre><code>#define OBJ_STRING 0    /* String object. */
#define OBJ_LIST 1      /* List object. */
#define OBJ_SET 2       /* Set object. */
#define OBJ_ZSET 3      /* Sorted set object. */
…
#define OBJ_NEWTYPE 7
</code></pre>
<h3 id="6-3"><strong>6-3 第三步：开发新类型的创建和释放函数</strong></h3>
<p>Redis 把数据类型的创建和释放函数都定义在了 <code>object.c</code> 文件中。所以，我们可以在这个文件中增加 <code>NewTypeObject</code> 的创建函数 <code>createNewTypeObject</code>，如下所示：</p>
<pre><code>robj *createNewTypeObject(void){
   NewTypeObject *h = newtypeNew(); 
   robj *o = createObject(OBJ_NEWTYPE,h);
   return o;
}
</code></pre>
<p><code>createNewTypeObject</code> 分别调用了 <code>newtypeNew</code> 和 <code>createObject</code> 两个函数，我分别来介绍下。</p>
<p>先说 <code>newtypeNew</code> 函数。它是用来为新数据类型初始化内存结构的。这个初始化过程主要是用 <code>zmalloc</code> 做底层结构分配空间，以便写入数据。</p>
<pre><code>NewTypeObject *newtypeNew(void){
    NewTypeObject *n = zmalloc(sizeof(*n));
    n-&gt;head = NULL;
    n-&gt;len = 0;
    return n;
}
</code></pre>
<p><code>newtypeNew</code> 函数涉及到新数据类型的具体创建，而 Redis 默认会为每个数据类型定义一个单独文件，实现这个类型的创建和命令操作，例如，<code>t_string.c</code> 和 <code>t_list.c</code> 分别对应 <code>String</code> 和<code>List</code> 类型。</p>
<p>按照 Redis 的惯例，我们就把 <code>newtypeNew</code> 函数定义在名为 <code>t_newtype.c</code> 的文件中。</p>
<p><code>createObject</code> 是 <code>Redis</code> 本身提供的 <code>RedisObject</code> 创建函数，它的参数是数据类型的 <code>type</code> 和指向数据类型实现的指针<code>*ptr</code>。</p>
<p>我们给 createObject 函数中传入了两个参数，分别是新类型的 type 值 <code>OBJ_NEWTYPE</code>，以及指向一个初始化过的 <code>NewTypeObject</code> 的指针。这样一来，创建的 <code>RedisObject</code> 就能指向我们自定义的新数据类型了。</p>
<pre><code>robj *createObject(int type, void *ptr) {
    robj *o = zmalloc(sizeof(*o));
    o-&gt;type = type;
    o-&gt;ptr = ptr;
    ...
    return o;
}
</code></pre>
<p>对于释放函数来说，它是创建函数的反过程，是用 zfree 命令把新结构的内存空间释放掉。</p>
<h3 id="6-4"><strong>6-4 第四步：开发新类型的命令操作</strong></h3>
<p>简单来说，增加相应的命令操作的过程可以分成三小步：</p>
<p>1.在 <code>t_newtype.c</code>文件中增加命令操作的实现。比如说，我们定义 <code>ntinsertCommand</code> 函数，由它实现对 <code>NewTypeObject</code> 单向链表的插入操作：</p>
<pre><code>void ntinsertCommand(client *c){
  //基于客户端传递的参数，实现在NewTypeObject链表头插入元素
}
</code></pre>
<p>2.在 server.h 文件中，声明我们已经实现的命令，以便在 server.c 文件引用这个命令，例如：</p>
<pre><code>void ntinsertCommand(client *c)
</code></pre>
<p>3.在 <code>server.c</code> 文件中的 <code>redisCommandTable</code> 里面，把新增命令和实现函数关联起来。例如，新增的 ntinsert 命令由 <code>ntinsertCommand</code> 函数实现，我们就可以用 <code>ntinsert</code> 命令给 <code>NewTypeObject</code> 数据类型插入元素了。</p>
<pre><code>struct redisCommand redisCommandTable[] = { 
...
{&quot;ntinsert&quot;,ntinsertCommand,2,&quot;m&quot;,...}
}
</code></pre>
<p>此时，我们就完成了一个自定义的 <code>NewTypeObject</code> 数据类型，可以实现基本的命令操作了。当然，如果你还希望新的数据类型能被持久化保存，我们还需要在 Redis 的 <code>RDB</code> 和 <code>AOF</code> 模块中增加对新数据类型进行持久化保存的代码，</p>
<h2 id="7"><strong>7、本节小结</strong></h2>
<p>GEO 本身并没有设计新的底层数据结构，而是直接使用了 Sorted Set 集合类型。</p>
<ul>
<li><code>GEO</code> 类型使用 <code>GeoHash</code> 编码方法实现了经纬度到 <code>Sorted Set</code> 中元素权重分数的转换，这其中的两个关键机制就是对二维地图做区间划分，以及对区间进行编码。</li>
<li>一组经纬度落在某个区间后，就用区间的编码值来表示，并把编码值作为 <code>Sorted Se</code> 元素的权重分数。</li>
<li>这样一来，我们就可以把经纬度保存到 <code>Sorted Set</code> 中，利用 <code>Sorted Set</code> 提供的“按权重进行有序范围查找”的特性，实现 LBS 服务中频繁使用的“搜索附近”的需求。</li>
</ul>
<p>GEO 属于 Redis 提供的扩展数据类型。扩展数据类型有两种实现途径：</p>
<ul>
<li>一种是基于现有的数据类型，通过数据编码或是实现新的操作的方式，来实现扩展数据类型，例如基于 Sorted Set 和 GeoHash 编码实现 GEO，以及基于 String 和位操作实现 Bitmap；</li>
<li>另一种就是开发自定义的数据类型，具体的操作是增加新数据类型的定义，实现创建和释放函数，实现新数据类型支持的命令操作</li>
</ul>
<h3 id="7-1"><strong>7-1 要点&amp;亮点？</strong></h3>
<ul>
<li>GEO的原理，这个是我之前所不知道的，学完后对GEO有了一些认知</li>
<li>Redis居然支持自定义数据存储结构，这打开了我的眼界</li>
<li><strong>GEO的底层实现，是sortSet，元素是车辆信息，权重是车辆经纬度转换过来的float值</strong></li>
<li><strong>GEOHash编码，基本原理“二分区间，区间编码”（二分法的应用，将一个值编码成N位的二进制值）</strong></li>
<li><strong>GEO使用GEOHash编码后，将经纬度，按照纬奇经偶位分别填充组合，得到一个车辆的经纬度编码值</strong></li>
<li>GEOHash编码实现的效果是将一个空间分割成为一个个方块，可以实现LBS服务（但编码值相近，不一定位置相近）</li>
</ul>
<h3 id="7-2"><strong>7-2 每课一问</strong></h3>
<p>Redis 的 5 大基本数据类型和 3 个扩展数据类型</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="../2redis_sets/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 第二节 Redis有那些数据结构适合做统计" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              第二节 Redis有那些数据结构适合做统计
            </div>
          </div>
        </a>
      
      
        
        <a href="../4redis_timeseries/" class="md-footer__link md-footer__link--next" aria-label="下一页: 第四节 根据时间序列数据的特点，选择合适的存储方案" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              第四节 根据时间序列数据的特点，选择合适的存储方案
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "search": "../../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.467223ff.min.js"></script>
      
    
  </body>
</html>